<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Est√°tico 2 | Ultra Seco</title>
    <!-- CSS and Tools -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <!-- Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        .price-text {
            display: none;
        }

        @media print {
            .no-print {
                display: none !important;
            }

            .price-text {
                display: block !important;
            }

            input,
            select,
            button {
                display: none !important;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 10pt;
            }

            th,
            td {
                border: 1px solid #ddd;
                padding: 5px;
            }

            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
            }
        }

        .print-header {
            display: none;
        }

        .bs-text {
            color: #2563eb;
            font-weight: bold;
            font-family: monospace;
            font-size: 10px;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- PANTALLA DE ACCESO -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
            <img src="images/logo.png" alt="Ultra Seco" class="h-16 mx-auto mb-4">
            <h2 class="text-2xl font-bold mb-2">Portal Est√°tico</h2>
            <p class="text-slate-500 mb-6 text-sm">Control Editable Manual</p>
            <input type="password" id="password-input" placeholder="Introducir clave de acceso"
                class="w-full p-3 border rounded-lg mb-4 outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="checkLogin()"
                class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Entrar</button>
            <p id="login-error" class="text-red-500 text-sm mt-3 hidden">Clave incorrecta</p>
        </div>
    </div>

    <!-- PANEL PRINCIPAL -->
    <div id="dashboard" class="hidden flex-1 flex flex-col">
        <header class="bg-slate-800 text-white shadow-lg p-4 sticky top-0 z-40">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="images/logo.png" alt="Logo" class="h-8 bg-white rounded p-1">
                    <span class="font-bold text-lg">Portal 2.0 (HTML Editable)</span>
                </div>
                <div class="flex gap-4">
                    <a href="index.html" class="hover:text-blue-300 text-sm"><i class="fa fa-home"></i> Volver</a>
                    <button onclick="location.reload()" class="text-sm bg-slate-700 px-3 py-1 rounded">Salir</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-6">
            <!-- PANEL DE CONTROL -->
            <div class="bg-white p-6 rounded-xl shadow-sm border mb-8 no-print">
                <div class="flex flex-wrap gap-6 items-end">
                    <!-- Tasa Euro -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Tasa Euro BCV (Bs.)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="euro-rate" value="400.49" step="0.01" oninput="recalcAll()"
                                class="w-32 p-2 border rounded font-bold text-blue-700 text-lg outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                    </div>

                    <!-- Aumento Masivo (Nuevo) -->
                    <div class="bg-orange-50 p-3 rounded-lg border border-orange-100 flex items-end gap-2">
                        <div>
                            <label class="block text-[10px] font-bold text-orange-700 mb-1 uppercase">Aumento Masivo
                                %</label>
                            <input type="number" id="bulk-pct" placeholder="5"
                                class="w-20 p-2 text-right font-bold border rounded focus:ring-2 focus:ring-orange-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-orange-700 mb-1 uppercase">Redondeo</label>
                            <select id="rounding-rule" class="p-2 text-xs border rounded bg-white outline-none">
                                <option value="none">Exacto</option>
                                <option value="99">.99</option>
                                <option value="50">.50</option>
                            </select>
                        </div>
                        <button onclick="applyBulkUpdate()"
                            class="bg-orange-500 hover:bg-orange-600 text-white font-bold px-4 py-2 rounded text-sm transition shadow-sm">
                            Aplicar
                        </button>
                    </div>

                    <!-- Deshacer -->
                    <button onclick="undo()" id="undo-btn" disabled
                        class="bg-gray-200 text-gray-400 font-bold px-4 py-2 rounded-lg flex items-center gap-2 transition disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-300 hover:text-gray-700">
                        <i class="fa-solid fa-rotate-left"></i> Deshacer
                    </button>

                    <!-- Filtrar por Categor√≠a (Nuevo) -->
                    <div class="flex flex-col gap-2 p-3 bg-slate-50 border rounded-lg">
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest px-1">Filtrar por
                            Categor√≠a</span>
                        <div class="flex flex-wrap gap-2" id="category-checks">
                            <label
                                class="flex items-center gap-1.5 px-2 py-1 bg-white border rounded text-xs cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" value="Construcci√≥n" checked onchange="applyFilter()"
                                    class="cat-check"> Construcci√≥n
                            </label>
                            <label
                                class="flex items-center gap-1.5 px-2 py-1 bg-white border rounded text-xs cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" value="Industria" checked onchange="applyFilter()"
                                    class="cat-check"> Industria
                            </label>
                            <label
                                class="flex items-center gap-1.5 px-2 py-1 bg-white border rounded text-xs cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" value="Vehicular" checked onchange="applyFilter()"
                                    class="cat-check"> Vehicular
                            </label>
                            <label
                                class="flex items-center gap-1.5 px-2 py-1 bg-white border rounded text-xs cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" value="Hogar" checked onchange="applyFilter()" class="cat-check">
                                Hogar
                            </label>
                        </div>
                    </div>

                    <!-- Buscador -->
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Buscar Producto</label>
                        <div class="relative">
                            <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="filter" oninput="applyFilter()" placeholder="Nombre del producto..."
                                class="w-full pl-10 p-2 border rounded outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                    </div>

                    <!-- Acciones -->
                    <div class="flex flex-col gap-2">
                        <div class="flex gap-2">
                            <button onclick="saveToStorage()"
                                class="bg-green-600 hover:bg-green-700 text-white font-bold px-4 py-2 rounded-lg shadow-lg hover:shadow-green-500/30 transition flex items-center transform hover:scale-105 text-sm">
                                <i class="fa-solid fa-save mr-2"></i> Guardar
                            </button>
                            <button onclick="window.print()"
                                class="bg-slate-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                <i class="fa-solid fa-print mr-2"></i> PDF
                            </button>
                        </div>
                        <!-- Sincronizaci√≥n Doble (NUEVO) -->
                        <div class="flex flex-col gap-2 p-2 bg-slate-50 border rounded-lg">
                            <div class="flex gap-2 items-center">
                                <input type="text" id="sheet-url" placeholder="URL CSV Google Sheets"
                                    value="https://docs.google.com/spreadsheets/d/e/2PACX-1vSeXNSKBis9vOIL_POvseYb0pPtyfRlvQT5X764jon7Yi4UKQ0iiA-1PbTPW6abYZkq8NeRYDt84Bo-/pub?output=csv"
                                    class="text-[10px] p-2 border rounded w-48 outline-none focus:ring-1 focus:ring-blue-400">
                                <button onclick="syncWithGoogleSheets()"
                                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-3 py-1 rounded text-[10px] transition flex items-center gap-1">
                                    <i class="fa-solid fa-sync"></i> Sheets
                                </button>
                            </div>
                            <div class="flex gap-2 items-center border-t pt-2 border-slate-200">
                                <div id="db-status" class="w-2 h-2 rounded-full bg-gray-400 ml-1"
                                    title="Status Firebase"></div>
                                <button onclick="toggleFirebaseConfig()"
                                    class="text-[10px] text-blue-600 hover:underline">Configurar Firebase</button>
                                <button onclick="syncFirebase()" id="btn-sync-firebase"
                                    class="bg-orange-500 hover:bg-orange-600 text-white font-bold px-3 py-1 rounded text-[10px] transition flex items-center gap-1 ml-auto">
                                    <i class="fa-solid fa-cloud-arrow-up"></i> Firebase
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="text-[9px] text-slate-400 mt-2">Sincroniza tus precios desde la nube usando Google Sheets o
                    Firebase Realtime Database.</p>
            </div>

            <!-- MODAL CONFIG FIREBASE -->
            <div id="firebase-modal"
                class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm">
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-fire text-orange-500"></i> Configuraci√≥n Firebase
                    </h3>
                    <p class="text-xs text-slate-500 mb-4">Pega aqu√≠ el objeto <code>firebaseConfig</code> obtenido de
                        la consola de Firebase.</p>
                    <textarea id="firebase-config-input" placeholder='{ "apiKey": "...", "databaseURL": "...", ... }'
                        class="w-full h-40 p-3 text-xs font-mono border rounded-lg mb-4 outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50"></textarea>
                    <div class="flex gap-2">
                        <button onclick="saveFirebaseConfig()"
                            class="flex-1 bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">Guardar y
                            Conectar</button>
                        <button onclick="toggleFirebaseConfig()"
                            class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">Cerrar</button>
                    </div>
                </div>
            </div>

            <div class="print-header">
                <img src="images/logo.png" alt="Ultra Seco" style="height: 50px; margin: 0 auto;">
                <h1 style="font-size: 20px; font-weight: bold;">Lista de Precios Oficial</h1>
                <p>Generado: <span id="current-date"></span></p>
            </div>

            <!-- TABLA EDITABLE -->
            <div class="bg-white rounded-xl shadow-lg border overflow-hidden">
                <table class="w-full text-left" id="main-table">
                    <thead class="bg-slate-100 text-[10px] font-bold text-slate-600 uppercase">
                        <tr>
                            <th class="p-4">Producto</th>
                            <th class="p-4">Presentaci√≥n</th>
                            <th class="p-4 text-right">Costo API</th>
                            <th class="p-4 text-right bg-blue-50">Precio Detal ($)</th>
                            <th class="p-4 text-right bg-green-50">Precio Mayor ($)</th>
                            <th class="p-4 text-right bg-purple-50">Distribuidor ($)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y text-sm">

                        <!-- FILA PRODUCTO: SOLUCION INTERIOR -->
                        <tr class="product-row" data-search="solucion interior construccion"
                            data-category="Construcci√≥n">
                            <td class="p-4">
                                <span class="font-bold text-slate-800">Ultra Seco Soluci√≥n Interior</span>
                            </td>
                            <td class="p-4">
                                <span class="text-xs text-slate-500">1 Litro</span>
                            </td>
                            <td class="p-4 text-right">
                                <input type="number" class="cost w-20 text-right p-1 border rounded bg-slate-50"
                                    value="8.00" oninput="recalcAll()">
                            </td>
                            <td class="p-4 text-right bg-blue-50/20">
                                <input type="number" class="price-detal w-20 text-right p-1 border rounded font-bold"
                                    value="13.99" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                                <div class="price-text font-bold">13.99 $</div>
                            </td>
                            <td class="p-4 text-right bg-green-50/20">
                                <input type="number" class="price-mayor w-20 text-right p-1 border rounded"
                                    value="11.89" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                                <div class="price-text font-bold">11.89 $</div>
                            </td>
                            <td class="p-4 text-right bg-purple-50/20">
                                <input type="number" class="price-dist w-20 text-right p-1 border rounded" value="9.79"
                                    oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                                <div class="price-text font-bold">9.79 $</div>
                            </td>
                        </tr>

                        <!-- FILA PRODUCTO: SOLUCION EXTERIOR -->
                        <tr class="product-row" data-search="solucion exterior construccion"
                            data-category="Construcci√≥n">
                            <td class="p-4">
                                <span class="font-bold text-slate-800">Ultra Seco Soluci√≥n Exterior</span>
                            </td>
                            <td class="p-4">
                                <span class="text-xs text-slate-500">1 Litro</span>
                            </td>
                            <td class="p-4 text-right">
                                <input type="number" class="cost w-20 text-right p-1 border rounded bg-slate-50"
                                    value="10.00" oninput="recalcAll()">
                            </td>
                            <td class="p-4 text-right bg-blue-50/20">
                                <input type="number" class="price-detal w-20 text-right p-1 border rounded font-bold"
                                    value="16.99" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-green-50/20">
                                <input type="number" class="price-mayor w-20 text-right p-1 border rounded"
                                    value="14.44" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-purple-50/20">
                                <input type="number" class="price-dist w-20 text-right p-1 border rounded" value="11.89"
                                    oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                        </tr>

                        <!-- FILA PRODUCTO: PINTURA HIDROFOBICA -->
                        <tr class="product-row" data-search="pintura hidrofobica construccion"
                            data-category="Construcci√≥n">
                            <td class="p-4">
                                <span class="font-bold text-slate-800">Pintura S√∫per Hidrof√≥bica</span>
                            </td>
                            <td class="p-4">
                                <span class="text-xs text-slate-500">Gal√≥n</span>
                            </td>
                            <td class="p-4 text-right">
                                <input type="number" class="cost w-20 text-right p-1 border rounded bg-slate-50"
                                    value="22.00" oninput="recalcAll()">
                            </td>
                            <td class="p-4 text-right bg-blue-50/20">
                                <input type="number" class="price-detal w-20 text-right p-1 border rounded font-bold"
                                    value="34.00" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-green-50/20">
                                <input type="number" class="price-mayor w-20 text-right p-1 border rounded"
                                    value="28.90" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-purple-50/20">
                                <input type="number" class="price-dist w-20 text-right p-1 border rounded" value="23.80"
                                    oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                        </tr>

                        <!-- FILA PRODUCTO: ESTUCO -->
                        <tr class="product-row" data-search="estuco super hidrofobico construccion"
                            data-category="Construcci√≥n">
                            <td class="p-4">
                                <span class="font-bold text-slate-800">Estuco S√∫per Hidrof√≥bico</span>
                            </td>
                            <td class="p-4">
                                <span class="text-xs text-slate-500">Gal√≥n</span>
                            </td>
                            <td class="p-4 text-right">
                                <input type="number" class="cost w-20 text-right p-1 border rounded bg-slate-50"
                                    value="12.00" oninput="recalcAll()">
                            </td>
                            <td class="p-4 text-right bg-blue-50/20">
                                <input type="number" class="price-detal w-20 text-right p-1 border rounded font-bold"
                                    value="19.00" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-green-50/20">
                                <input type="number" class="price-mayor w-20 text-right p-1 border rounded"
                                    value="16.15" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-purple-50/20">
                                <input type="number" class="price-dist w-20 text-right p-1 border rounded" value="13.30"
                                    oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                        </tr>

                        <!-- FILA PRODUCTO: ADITIVO ASFATICO -->
                        <tr class="product-row" data-search="aditivo asfaltico industria" data-category="Industria">
                            <td class="p-4">
                                <span class="font-bold text-slate-800">Aditivo Asf√°ltico</span>
                            </td>
                            <td class="p-4">
                                <span class="text-xs text-slate-500">Tambor (200L)</span>
                            </td>
                            <td class="p-4 text-right">
                                <input type="number" class="cost w-20 text-right p-1 border rounded bg-slate-50"
                                    value="2800.00" oninput="recalcAll()">
                            </td>
                            <td class="p-4 text-right bg-blue-50/20">
                                <input type="number" class="price-detal w-20 text-right p-1 border rounded font-bold"
                                    value="3500.00" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-green-50/20">
                                <input type="number" class="price-mayor w-20 text-right p-1 border rounded"
                                    value="2975.00" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-purple-50/20">
                                <input type="number" class="price-dist w-20 text-right p-1 border rounded"
                                    value="2450.00" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                        </tr>

                        <!-- FILA PRODUCTO: MAGNETRON -->
                        <tr class="product-row" data-search="magnetron eco capturador industria"
                            data-category="Industria">
                            <td class="p-4">
                                <span class="font-bold text-slate-800">Magnetron Eco Capturador</span>
                            </td>
                            <td class="p-4">
                                <span class="text-xs text-slate-500">Gal√≥n</span>
                            </td>
                            <td class="p-4 text-right">
                                <input type="number" class="cost w-20 text-right p-1 border rounded bg-slate-50"
                                    value="210.00" oninput="recalcAll()">
                            </td>
                            <td class="p-4 text-right bg-blue-50/20">
                                <input type="number" class="price-detal w-20 text-right p-1 border rounded font-bold"
                                    value="345.00" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-green-50/20">
                                <input type="number" class="price-mayor w-20 text-right p-1 border rounded"
                                    value="293.25" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-purple-50/20">
                                <input type="number" class="price-dist w-20 text-right p-1 border rounded"
                                    value="241.50" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                        </tr>

                        <!-- FILA PRODUCTO: ECO CAPTURADOR -->
                        <tr class="product-row" data-search="eco capturador mineria industria"
                            data-category="Industria">
                            <td class="p-4">
                                <span class="font-bold text-slate-800">Eco Capturador (Miner√≠a)</span>
                            </td>
                            <td class="p-4">
                                <span class="text-xs text-slate-500">1 Litro</span>
                            </td>
                            <td class="p-4 text-right">
                                <input type="number" class="cost w-20 text-right p-1 border rounded bg-slate-50"
                                    value="50.00" oninput="recalcAll()">
                            </td>
                            <td class="p-4 text-right bg-blue-50/20">
                                <input type="number" class="price-detal w-20 text-right p-1 border rounded font-bold"
                                    value="85.00" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-green-50/20">
                                <input type="number" class="price-mayor w-20 text-right p-1 border rounded"
                                    value="72.25" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-purple-50/20">
                                <input type="number" class="price-dist w-20 text-right p-1 border rounded" value="59.50"
                                    oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                        </tr>

                        <!-- FILA PRODUCTO: ESCUDO CERAMICO -->
                        <tr class="product-row" data-search="escudo ceramico hogar" data-category="Hogar">
                            <td class="p-4">
                                <span class="font-bold text-slate-800">Escudo Cer√°mico</span>
                            </td>
                            <td class="p-4">
                                <span class="text-xs text-slate-500">1 Litro</span>
                            </td>
                            <td class="p-4 text-right">
                                <input type="number" class="cost w-20 text-right p-1 border rounded bg-slate-50"
                                    value="25.00" oninput="recalcAll()">
                            </td>
                            <td class="p-4 text-right bg-blue-50/20">
                                <input type="number" class="price-detal w-20 text-right p-1 border rounded font-bold"
                                    value="45.00" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-green-50/20">
                                <input type="number" class="price-mayor w-20 text-right p-1 border rounded"
                                    value="38.25" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-purple-50/20">
                                <input type="number" class="price-dist w-20 text-right p-1 border rounded" value="31.50"
                                    oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                        </tr>

                        <!-- FILA PRODUCTO: CHAMPU NANO (VEHICULAR) -->
                        <tr class="product-row" data-search="champu nano concentrado vehicular"
                            data-category="Vehicular">
                            <td class="p-4">
                                <span class="font-bold text-slate-800">Champ√∫ Nano-Concentrado</span>
                            </td>
                            <td class="p-4">
                                <span class="text-xs text-slate-500">1 Litro</span>
                            </td>
                            <td class="p-4 text-right">
                                <input type="number" class="cost w-20 text-right p-1 border rounded bg-slate-50"
                                    value="7.00" oninput="recalcAll()">
                            </td>
                            <td class="p-4 text-right bg-blue-50/20">
                                <input type="number" class="price-detal w-20 text-right p-1 border rounded font-bold"
                                    value="12.00" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-green-50/20">
                                <input type="number" class="price-mayor w-20 text-right p-1 border rounded"
                                    value="10.20" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-purple-50/20">
                                <input type="number" class="price-dist w-20 text-right p-1 border rounded" value="8.40"
                                    oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                        </tr>

                        <!-- FILA PRODUCTO: CERA NANO (VEHICULAR) -->
                        <tr class="product-row" data-search="cera nano protectora vehicular" data-category="Vehicular">
                            <td class="p-4">
                                <span class="font-bold text-slate-800">Cera Nano Protectora</span>
                            </td>
                            <td class="p-4">
                                <span class="text-xs text-slate-500">500ml</span>
                            </td>
                            <td class="p-4 text-right">
                                <input type="number" class="cost w-20 text-right p-1 border rounded bg-slate-50"
                                    value="8.50" oninput="recalcAll()">
                            </td>
                            <td class="p-4 text-right bg-blue-50/20">
                                <input type="number" class="price-detal w-20 text-right p-1 border rounded font-bold"
                                    value="15.00" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-green-50/20">
                                <input type="number" class="price-mayor w-20 text-right p-1 border rounded"
                                    value="12.75" oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                            <td class="p-4 text-right bg-purple-50/20">
                                <input type="number" class="price-dist w-20 text-right p-1 border rounded" value="10.50"
                                    oninput="recalcAll()">
                                <div class="bs-text">Bs --</div>
                            </td>
                        </tr>

                    </tbody>
                </table>
            </div>

            <div class="mt-8 text-center text-slate-400 text-xs py-10">
                &copy; 2026 Ultra Seco - Portal de Gesti√≥n v2.0 HTML Editable
            </div>
        </main>
    </div>

    <!-- C√ìDIGO DE LOGICA -->
    <script>
        // Clave para guardar los datos
        const STORAGE_KEY = 'portal2_data';

        function checkLogin() {
            const pass = document.getElementById('password-input').value;
            if (pass === "admin123") {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('current-date').textContent = new Date().toLocaleDateString();

                loadPersistentData(); // Cargar lo guardado anteriormente

                // Si hay una URL de Google Sheets guardada, sincronizar autom√°ticamente
                const savedUrl = localStorage.getItem('google_sheet_url');
                if (savedUrl) {
                    document.getElementById('sheet-url').value = savedUrl;
                    // syncWithGoogleSheets(); // Opcional: auto-sync sheets
                }

                // Autoconectar Firebase si hay config
                initFirebaseFromStorage();

                recalcAll();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        // ==========================================
        // FIREBASE LOGIC
        // ==========================================
        let db = null;

        function toggleFirebaseConfig() {
            document.getElementById('firebase-modal').classList.toggle('hidden');
        }

        function saveFirebaseConfig() {
            let configText = document.getElementById('firebase-config-input').value.trim();

            try {
                // Inteligencia para limpiar el pegado accidental de c√≥digo JS
                // 1. Intentar extraer solo lo que est√° entre llaves { }
                const match = configText.match(/\{[\s\S]*\}/);
                if (match) configText = match[0];

                // 2. Convertir "Lazy JSON" (sin comillas en llaves) a JSON estricto
                // Esto permite pegar directamente el objeto de la consola de Firebase
                const jsonLike = configText
                    .replace(/(\w+):/g, '"$1":') // Llaves sin comillas
                    .replace(/'/g, '"')          // Comillas simples a dobles
                    .replace(/,\s*}/g, '}')      // Quitar comas sobrantes al final
                    .replace(/,\s*\]/g, ']');    // Quitar comas sobrantes en arrays

                const config = JSON.parse(jsonLike);
                localStorage.setItem('firebase_config', JSON.stringify(config));
                initFirebase(config);
                toggleFirebaseConfig();
                alert("‚úÖ Configuraci√≥n de Firebase guardada y conectada.");
            } catch (e) {
                console.error("Error de parseo:", e);
                alert("‚ùå Error: El formato pegado no es correcto.\n\nIntenta copiar solo desde la llave { hasta la llave } inclusive.");
            }
        }

        function initFirebaseFromStorage() {
            const savedConfig = localStorage.getItem('firebase_config');
            if (savedConfig) {
                document.getElementById('firebase-config-input').value = savedConfig;
                try {
                    initFirebase(JSON.parse(savedConfig));
                } catch (e) {
                    console.error("Error cargando Firebase config guardado");
                }
            }
        }

        function initFirebase(config) {
            if (firebase.apps.length === 0) {
                firebase.initializeApp(config);
            }
            db = firebase.database();

            // Actualizar status UI
            const statusDot = document.getElementById('db-status');
            statusDot.classList.remove('bg-gray-400', 'bg-red-500');
            statusDot.classList.add('bg-green-500');

            // Escuchar cambios en tiempo real
            db.ref('productos').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateTableFromFirebase(data);
                    console.log("üî• Datos sincronizados desde Firebase");
                    showSaveStatus("Datos actualizados desde la nube");
                }
            });

            // Escuchar tasa euro
            db.ref('configuracion/tasa_euro_bcv').on('value', (snapshot) => {
                const tasa = snapshot.val();
                if (tasa) {
                    document.getElementById('euro-rate').value = tasa;
                    recalcAll();
                }
            });
        }

        function syncFirebase() {
            if (!db) return alert("‚ùå Primero configura Firebase.");

            const syncBtn = document.getElementById('btn-sync-firebase');
            syncBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Subiendo...';

            const data = {
                tasa_euro_bcv: parseFloat(document.getElementById('euro-rate').value),
                ultima_actualizacion: new Date().toISOString()
            };

            const productos = {};
            document.querySelectorAll('.product-row').forEach(row => {
                const name = row.querySelector('.font-bold').textContent.trim();
                const key = name.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '');

                productos[key] = {
                    nombre: name,
                    presentacion: row.cells[1].textContent.trim(),
                    costo: parseFloat(row.querySelector('.cost').value),
                    precio_detal: parseFloat(row.querySelector('.price-detal').value),
                    precio_mayor: parseFloat(row.querySelector('.price-mayor').value),
                    distribuidor: parseFloat(row.querySelector('.price-dist').value)
                };
            });

            // Guardar en Firebase
            Promise.all([
                db.ref('productos').set(productos),
                db.ref('configuracion').set(data)
            ]).then(() => {
                alert("üöÄ Datos subidos a Firebase correctamente.");
                syncBtn.innerHTML = '<i class="fa-solid fa-cloud-arrow-down"></i> Sincronizar';
            }).catch(err => {
                alert("‚ùå Error al subir datos: " + err.message);
                syncBtn.innerHTML = '<i class="fa-solid fa-cloud-arrow-down"></i> Sincronizar';
            });
        }

        function updateTableFromFirebase(productos) {
            const rows = document.querySelectorAll('.product-row');

            rows.forEach(row => {
                const rowName = row.querySelector('.font-bold').textContent.trim();
                // Buscar en el objeto de productos de Firebase
                for (const key in productos) {
                    if (productos[key].nombre === rowName) {
                        row.querySelector('.cost').value = productos[key].costo || 0;
                        row.querySelector('.price-detal').value = productos[key].precio_detal || 0;
                        row.querySelector('.price-mayor').value = productos[key].precio_mayor || 0;
                        row.querySelector('.price-dist').value = productos[key].distribuidor || 0;
                        break;
                    }
                }
            });
            recalcAll();
        }

        async function syncWithGoogleSheets() {
            const url = document.getElementById('sheet-url').value.trim();
            if (!url) {
                alert("Por favor, ingresa la URL del CSV de Google Sheets.");
                return;
            }

            // Validar que sea un enlace de Google Sheets CSV
            if (!url.includes('docs.google.com/spreadsheets') || !url.includes('output=csv')) {
                alert("La URL no parece ser de un CSV publicado de Google Sheets. Verifica las instrucciones abajo.");
                return;
            }

            try {
                // Notificar inicio de carga
                const syncBtn = document.querySelector('button[onclick="syncWithGoogleSheets()"]');
                const originalText = syncBtn.innerHTML;
                syncBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sincronizando...';
                syncBtn.disabled = true;

                const response = await fetch(url);
                if (!response.ok) throw new Error("No se pudo obtener el archivo de Google Sheets.");

                const csvText = await response.text();
                parseAndPopulateTable(csvText);

                // Guardar la URL para futuras cargas
                localStorage.setItem('google_sheet_url', url);

                syncBtn.innerHTML = originalText;
                syncBtn.disabled = false;

                alert("‚úÖ Tabla sincronizada con √©xito desde Google Sheets.");
                recalcAll();
                saveToStorage();
            } catch (error) {
                console.error("Error al sincronizar:", error);
                alert("‚ùå Error al conectar con Google Sheets: " + error.message);

                const syncBtn = document.querySelector('button[onclick="syncWithGoogleSheets()"]');
                syncBtn.innerHTML = '<i class="fa-solid fa-sync"></i> Sincronizar';
                syncBtn.disabled = false;
            }
        }

        function parseAndPopulateTable(csvText) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
            const rows = document.querySelectorAll('.product-row');

            // Funci√≥n para parsear una l√≠nea de CSV respetando comillas
            function parseCSVLine(text) {
                const result = [];
                let cur = '';
                let inQuote = false;
                for (let i = 0; i < text.length; i++) {
                    let char = text[i];
                    if (char === '"') {
                        inQuote = !inQuote;
                    } else if (char === ',' && !inQuote) {
                        result.push(cur.trim());
                        cur = '';
                    } else {
                        cur += char;
                    }
                }
                result.push(cur.trim());
                return result;
            }

            // Encontrar el √≠ndice de la cabecera real (donde empieza "Producto")
            let headerIndex = -1;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].toLowerCase().includes("producto")) {
                    headerIndex = i;
                    break;
                }
            }

            if (headerIndex === -1) {
                console.warn("No se encontr√≥ la fila de cabecera 'Producto' en el CSV.");
                return;
            }

            const dataRows = lines.slice(headerIndex + 1);

            dataRows.forEach((csvLine) => {
                const values = parseCSVLine(csvLine);
                if (values.length < 6) return;

                // Estructura: Producto, Presentaci√≥n, Costo, Detal, Mayor, Dist
                const productName = values[0];

                rows.forEach(row => {
                    const rowProductName = row.querySelector('.font-bold').textContent.trim();
                    if (rowProductName === productName) {
                        // Limpiar formato num√©rico (quitar comas de miles)
                        const cleanNum = (str) => {
                            if (!str) return "0";
                            return str.replace(/,/g, '').replace(/[^\d.]/g, '');
                        };

                        if (values[2]) row.querySelector('.cost').value = cleanNum(values[2]);
                        if (values[3]) row.querySelector('.price-detal').value = cleanNum(values[3]);
                        if (values[4]) row.querySelector('.price-mayor').value = cleanNum(values[4]);
                        if (values[5]) row.querySelector('.price-dist').value = cleanNum(values[5]);
                    }
                });
            });
        }

        // Funci√≥n para guardar TODO el estado de la tabla autom√°ticamente
        function saveToStorage() {
            const data = {
                euro: document.getElementById('euro-rate').value,
                products: []
            };

            const rows = document.querySelectorAll('.product-row');
            rows.forEach((row, index) => {
                data.products.push({
                    cost: row.querySelector('.cost').value,
                    detal: row.querySelector('.price-detal').value,
                    mayor: row.querySelector('.price-mayor').value,
                    dist: row.querySelector('.price-dist').value
                });
            });

            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

            // Mostrar un peque√±o indicador de "Guardado"
            showSaveStatus();
        }

        // Funci√≥n para cargar los datos al entrar
        function loadPersistentData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;

            const data = JSON.parse(saved);

            // Restaurar Euro
            if (data.euro) document.getElementById('euro-rate').value = data.euro;

            // Restaurar Filas
            const rows = document.querySelectorAll('.product-row');
            data.products.forEach((prod, index) => {
                if (rows[index]) {
                    rows[index].querySelector('.cost').value = prod.cost;
                    rows[index].querySelector('.price-detal').value = prod.detal;
                    rows[index].querySelector('.price-mayor').value = prod.mayor;
                    rows[index].querySelector('.price-dist').value = prod.dist;
                }
            });
        }

        function recalcAll() {
            const euro = parseFloat(document.getElementById('euro-rate').value) || 0;
            const rows = document.querySelectorAll('.product-row');

            rows.forEach(row => {
                const inputs = {
                    detal: row.querySelector('.price-detal'),
                    mayor: row.querySelector('.price-mayor'),
                    dist: row.querySelector('.price-dist')
                };

                const bsTexts = row.querySelectorAll('.bs-text');
                const priceTexts = row.querySelectorAll('.price-text');

                const pDetal = parseFloat(inputs.detal.value) || 0;
                bsTexts[0].textContent = "Bs " + (pDetal * euro).toLocaleString('es-VE', { minimumFractionDigits: 2 });
                if (priceTexts[0]) priceTexts[0].textContent = pDetal.toFixed(2) + " $";

                const pMayor = parseFloat(inputs.mayor.value) || 0;
                if (bsTexts[1]) bsTexts[1].textContent = "Bs " + (pMayor * euro).toLocaleString('es-VE', { minimumFractionDigits: 2 });
                if (priceTexts[1]) priceTexts[1].textContent = pMayor.toFixed(2) + " $";

                const pDist = parseFloat(inputs.dist.value) || 0;
                if (bsTexts[2]) bsTexts[2].textContent = "Bs " + (pDist * euro).toLocaleString('es-VE', { minimumFractionDigits: 2 });
                if (priceTexts[2]) priceTexts[2].textContent = pDist.toFixed(2) + " $";
            });
        }

        function showSaveStatus() {
            let status = document.getElementById('save-status');
            if (!status) {
                status = document.createElement('div');
                status.id = 'save-status';
                status.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-full text-xs font-bold shadow-lg flex items-center gap-2 transition-opacity duration-500';
                status.innerHTML = '<i class="fa fa-check"></i> Cambios Guardados Permanentemente';
                document.body.appendChild(status);
            }
            status.style.opacity = '1';
            setTimeout(() => { status.style.opacity = '0'; }, 2000);
        }

        // --- HISTORIAL / UNDO ---
        let historyStack = [];

        function pushHistory() {
            const currentData = [];
            const rows = document.querySelectorAll('.product-row');
            rows.forEach(row => {
                currentData.push({
                    cost: row.querySelector('.cost').value,
                    detal: row.querySelector('.price-detal').value,
                    mayor: row.querySelector('.price-mayor').value,
                    dist: row.querySelector('.price-dist').value
                });
            });

            if (historyStack.length >= 10) historyStack.shift(); // Max 10 pasos
            historyStack.push(JSON.parse(JSON.stringify(currentData)));

            const undoBtn = document.getElementById('undo-btn');
            if (undoBtn) {
                undoBtn.disabled = false;
                undoBtn.classList.remove('bg-gray-200', 'text-gray-400');
                undoBtn.classList.add('bg-white', 'text-slate-700', 'border');
            }
        }

        function undo() {
            if (historyStack.length === 0) return;

            const lastState = historyStack.pop();
            const rows = document.querySelectorAll('.product-row');

            lastState.forEach((prod, index) => {
                if (rows[index]) {
                    rows[index].querySelector('.cost').value = prod.cost;
                    rows[index].querySelector('.price-detal').value = prod.detal;
                    rows[index].querySelector('.price-mayor').value = prod.mayor;
                    rows[index].querySelector('.price-dist').value = prod.dist;
                }
            });

            if (historyStack.length === 0) {
                const undoBtn = document.getElementById('undo-btn');
                if (undoBtn) {
                    undoBtn.disabled = true;
                    undoBtn.classList.add('bg-gray-200', 'text-gray-400');
                    undoBtn.classList.remove('bg-white', 'text-slate-700', 'border');
                }
            }

            recalcAll(); // Actualizar Bs y guardar en Storage
            alert('‚è™ Cambios revertidos.');
        }

        // --- AUMENTO MASIVO ---
        function applyBulkUpdate() {
            const pctInput = document.getElementById('bulk-pct').value;
            const rounding = document.getElementById('rounding-rule').value;

            if (!pctInput) return alert('Por favor, ingrese un porcentaje de aumento.');

            const pct = parseFloat(pctInput) / 100;

            if (confirm(`¬øSeguro que desea aplicar un aumento del ${pctInput}% a TODOS los productos VISIBLES en la tabla?`)) {
                pushHistory(); // <--- GUARDAR HISTORIAL ANTES DE CAMBIAR

                const rows = document.querySelectorAll('.product-row');
                let count = 0;

                rows.forEach(row => {
                    // Solo aplicar si la fila es visible (pasa los filtros actuales)
                    if (row.style.display !== "none") {
                        const inputs = {
                            detal: row.querySelector('.price-detal'),
                            mayor: row.querySelector('.price-mayor'),
                            dist: row.querySelector('.price-dist')
                        };

                        inputs.detal.value = calculateNewBulkPrice(parseFloat(inputs.detal.value) || 0, pct, rounding);
                        inputs.mayor.value = calculateNewBulkPrice(parseFloat(inputs.mayor.value) || 0, pct, rounding);
                        inputs.dist.value = calculateNewBulkPrice(parseFloat(inputs.dist.value) || 0, pct, rounding);
                        count++;
                    }
                });

                recalcAll(); // Actualizar bol√≠vares y guardar en Storage
                alert(`‚úÖ Aumento masivo aplicado a ${count} productos.`);
            }
        }

        function calculateNewBulkPrice(oldPrice, pct, rounding) {
            if (oldPrice <= 0) return 0;
            let newPrice = oldPrice * (1 + pct);

            if (rounding === '99') {
                newPrice = Math.floor(newPrice) + 0.99;
            } else if (rounding === '50') {
                newPrice = Math.floor(newPrice) + 0.50;
            } else {
                newPrice = Math.round(newPrice * 100) / 100; // Exacto
            }
            return newPrice.toFixed(2);
        }

        function applyFilter() {
            const query = document.getElementById('filter').value.toLowerCase();
            const activeCats = Array.from(document.querySelectorAll('.cat-check:checked')).map(cb => cb.value.toLowerCase());
            const rows = document.querySelectorAll('.product-row');

            rows.forEach(row => {
                const searchStr = row.getAttribute('data-search').toLowerCase();
                const category = row.dataset.category ? row.dataset.category.toLowerCase() : "";

                // Si la fila no tiene data-category, intentamos extraerla del data-search
                let rowCat = category;
                if (!rowCat) {
                    if (searchStr.includes('construccion')) rowCat = 'construcci√≥n';
                    else if (searchStr.includes('industria')) rowCat = 'industria';
                    else if (searchStr.includes('vehicular')) rowCat = 'vehicular';
                    else if (searchStr.includes('hogar')) rowCat = 'hogar';
                }

                const matchesQuery = searchStr.includes(query);
                const matchesCat = activeCats.length === 0 || activeCats.includes(rowCat);

                if (matchesQuery && matchesCat) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }
    </script>
</body>

</html>